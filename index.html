<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™æŒ‘æˆ°ç³»çµ±</title>
    <style>
        :root { --main-blue: #007bff; --success-green: #28a745; --fail-red: #dc3545; --warn-orange: #fd7e14; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* ç‹€æ…‹é¡¯ç¤º */
        .status-container { display: flex; justify-content: space-around; text-align: center; }
        .status-box { flex: 1; }
        .status-num { font-size: 24px; font-weight: bold; display: block; }
        
        /* ä»»å‹™æ¸…å–®æ¨£å¼ */
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f1f1; }
        .item:last-child { border-bottom: none; }
        .task-text { flex-grow: 1; font-size: 16px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-draw { background: var(--main-blue); color: white; width: 100%; padding: 15px; font-size: 18px; }
        .btn-ok { background: var(--success-green); color: white; margin-right: 5px; }
        .btn-no { background: var(--fail-red); color: white; }
        .btn-del { background: #666; color: white; padding: 4px 8px; font-size: 12px; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }

        /* æ‡²ç½°å€åŸŸ */
        #punishBanner { background: #fff3f3; border: 2px dashed var(--fail-red); padding: 15px; border-radius: 8px; color: var(--fail-red); text-align: center; margin-bottom: 20px; display: none; }

        /* è¼¸å…¥æ¡† */
        .input-area { display: flex; gap: 5px; margin-top: 10px; }
        input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="card">
        <h1 style="text-align: center; margin: 0 0 20px 0;">ğŸ® æˆ‘çš„æˆé•·ç³»çµ±</h1>
        <div class="status-container">
            <div class="status-box">
                <span class="status-num" style="color: var(--success-green);" id="scoreDisplay">0</span>
                ç´¯ç©ç©åˆ†
            </div>
            <div class="status-box">
                <span class="status-num" style="color: var(--fail-red);" id="failDisplay">0 / 3</span>
                å¤±æ•—ç´¯ç©
            </div>
        </div>
        <button class="btn-draw" style="margin-top:20px;" onclick="drawTasks()">ğŸ² æŠ½å–ä»Šæ—¥ä»»å‹™</button>
    </div>

    <div id="punishBanner">
        <h3>ğŸš¨ æ‡²ç½°åŸ·è¡Œä¸­</h3>
        <p id="punishText" style="font-size: 18px; font-weight: bold;"></p>
        <button class="btn-ok" onclick="clearPunish()">æˆ‘å·²å®Œæˆæ‡²ç½° (é‡ç½®å¤±æ•—æ•¸)</button>
    </div>

    <div class="card">
        <h2>ğŸ¯ ä»Šæ—¥ä»»å‹™</h2>
        <div id="todayList">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹...</div>
    </div>

    <div class="card">
        <h2>ğŸ“š ä¸€èˆ¬ä»»å‹™åº«</h2>
        <div class="input-area">
            <input type="text" id="taskInput" placeholder="è¼¸å…¥ä»»å‹™æŒ‡ä»¤...">
            <button class="btn-ok" onclick="addToPool('normal')">æ–°å¢</button>
        </div>
        <div id="normalPool" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <div class="card">
        <h2>ğŸ’€ æ‡²ç½°ä»»å‹™åº«</h2>
        <div class="input-area">
            <input type="text" id="punishInput" placeholder="è¼¸å…¥æ‡²ç½°å…§å®¹...">
            <button class="btn-no" onclick="addToPool('punish')">æ–°å¢</button>
        </div>
        <div id="punishPool" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <script>
        // --- 1. è³‡æ–™è®€å–èˆ‡é è¨­å€¼ ---
        const defaultTasks = ["å–æ°´ 500cc", "æ·±è¹² 10 ä¸‹", "çœ‹æ›¸ 10 åˆ†é˜"];
        const defaultPunishments = ["åŸåœ°è·³ 50 ä¸‹", "æ”¾ä¸‹æ‰‹æ©Ÿ 30 åˆ†é˜"];

        let data = {
            score: parseInt(localStorage.getItem('task_score')) || 0,
            failCount: parseInt(localStorage.getItem('task_fail')) || 0,
            normalPool: JSON.parse(localStorage.getItem('task_pool_normal')) || defaultTasks,
            punishPool: JSON.parse(localStorage.getItem('task_pool_punish')) || defaultPunishments,
            todayTasks: JSON.parse(localStorage.getItem('task_today')) || [],
            activePunish: localStorage.getItem('task_active_punish') || ""
        };

        // --- 2. æ ¸å¿ƒé‚è¼¯ ---

        // æŠ½å–ä»»å‹™
        function drawTasks() {
            if (data.activePunish) return alert("è«‹å…ˆå®Œæˆæ‡²ç½°ä»»å‹™ï¼");
            if (data.normalPool.length < 3) return alert("ä»»å‹™åº«è‡³å°‘éœ€è¦ 3 å€‹ä»»å‹™ï¼");
            
            // éš¨æ©Ÿé¸ä¸‰å€‹
            const shuffled = [...data.normalPool].sort(() => 0.5 - Math.random());
            data.todayTasks = shuffled.slice(0, 3).map(cmd => ({ cmd, status: 'pending' }));
            
            saveAndRender();
        }

        // å®Œæˆæˆ–å¤±æ•—
        function updateTaskStatus(index, status) {
            if (data.todayTasks[index].status !== 'pending') return;

            data.todayTasks[index].status = status;

            if (status === 'done') {
                data.score += 10;
            } else {
                data.failCount++;
                if (data.failCount >= 3) {
                    triggerPunish();
                }
            }
            saveAndRender();
        }

        // è§¸ç™¼æ‡²ç½°
        function triggerPunish() {
            if (data.punishPool.length === 0) {
                data.activePunish = "ç„¡é è¨­æ‡²ç½°ï¼Œè«‹è‡ªè¨‚æ‡²ç½°å…§å®¹ï¼";
            } else {
                const rand = Math.floor(Math.random() * data.punishPool.length);
                data.activePunish = data.punishPool[rand];
            }
            alert("âŒ å¤±æ•—ä¸‰æ¬¡ï¼è§¸ç™¼æ‡²ç½°ï¼š" + data.activePunish);
        }

        // æ¸…é™¤æ‡²ç½°
        function clearPunish() {
            data.activePunish = "";
            data.failCount = 0;
            saveAndRender();
        }

        // æ–°å¢ä»»å‹™åˆ°åº«
        function addToPool(type) {
            const input = type === 'normal' ? document.getElementById('taskInput') : document.getElementById('punishInput');
            const val = input.value.trim();
            if (!val) return;

            if (type === 'normal') data.normalPool.push(val);
            else data.punishPool.push(val);

            input.value = "";
            saveAndRender();
        }

        // åˆªé™¤åº«ä¸­ä»»å‹™
        function deleteFromPool(type, index) {
            if (type === 'normal') data.normalPool.splice(index, 1);
            else data.punishPool.splice(index, 1);
            saveAndRender();
        }

        // --- 3. ç•«é¢æ¸²æŸ“èˆ‡å„²å­˜ ---

        function saveAndRender() {
            // å„²å­˜è‡³æœ¬åœ°
            localStorage.setItem('task_score', data.score);
            localStorage.setItem('task_fail', data.failCount);
            localStorage.setItem('task_pool_normal', JSON.stringify(data.normalPool));
            localStorage.setItem('task_pool_punish', JSON.stringify(data.punishPool));
            localStorage.setItem('task_today', JSON.stringify(data.todayTasks));
            localStorage.setItem('task_active_punish', data.activePunish);

            // æ›´æ–°æ•¸æ“šé¡¯ç¤º
            document.getElementById('scoreDisplay').innerText = data.score;
            document.getElementById('failDisplay').innerText = data.failCount + " / 3";

            // æ‡²ç½°å€é¡¯ç¤º
            const banner = document.getElementById('punishBanner');
            if (data.activePunish) {
                banner.style.display = 'block';
                document.getElementById('punishText').innerText = data.activePunish;
            } else {
                banner.style.display = 'none';
            }

            // ä»Šæ—¥ä»»å‹™åˆ—è¡¨æ¸²æŸ“
            const todayDiv = document.getElementById('todayList');
            if (data.todayTasks.length === 0) {
                todayDiv.innerHTML = "å°šæœªæŠ½å–ä»»å‹™";
            } else {
                todayDiv.innerHTML = data.todayTasks.map((t, i) => `
                    <div class="item">
                        <span class="task-text" style="${t.status !== 'pending' ? 'text-decoration: line-through; color: #999;' : ''}">${t.cmd}</span>
                        ${t.status === 'pending' ? `
                            <button class="btn-ok" onclick="updateTaskStatus(${i}, 'done')">å®Œæˆ</button>
                            <button class="btn-no" onclick="updateTaskStatus(${i}, 'fail')">å¤±æ•—</button>
                        ` : `<span>${t.status === 'done' ? 'âœ…' : 'âŒ'}</span>`}
                    </div>
                `).join('');
            }

            // ä»»å‹™åº«æ¸²æŸ“
            renderPoolList('normalPool', 'normal');
            renderPoolList('punishPool', 'punish');
        }

        function renderPoolList(elementId, type) {
            const list = type === 'normal' ? data.normalPool : data.punishPool;
            document.getElementById(elementId).innerHTML = list.map((cmd, i) => `
                <div class="item">
                    <span style="font-size: 14px;">${cmd}</span>
                    <button class="btn-del" onclick="deleteFromPool('${type}', ${i})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        // åˆå§‹å•Ÿå‹•
        saveAndRender();

    </script>
</body>
</html>
